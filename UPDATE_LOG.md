# 修复日志

## 修复内容

### 1. 视频显示问题修复 ✅

**问题**: 视频播放器只显示音频，没有视频画面

**原因**: 缺少视频输出设置

**修复位置**: [gui/video_player.py](gui/video_player.py:30)

**修复内容**:
```python
# 添加了视频输出设置
self.media_player.setVideoOutput(self.video_widget)
```

### 2. 字幕文件保存功能 ✅

**问题**: 生成的字幕没有保存为用户可访问的文件，下次打开需要重新翻译

**修复位置**: [gui/upload_dialog.py](gui/upload_dialog.py:70-81)

**修复内容**:
1. **保存JSON格式**: 在视频同目录保存 `{视频名}_bilingual.json`
2. **保存SRT格式**: 在视频同目录保存 `{视频名}_bilingual.srt`
3. **保留缓存**: 同时保存到缓存目录，保持原有功能

**保存的文件格式**:
- `视频名_bilingual.json` - JSON格式，包含完整的时间戳和双语文本
- `视频名_bilingual.srt` - SRT格式，可在通用播放器中使用

### 3. 自动检测已存在字幕 ✅

**新增功能**: 打开视频时自动检测是否已存在字幕文件

**修复位置**: [gui/upload_dialog.py](gui/upload_dialog.py:187-209)

**功能说明**:
1. 打开视频时，自动检查同目录下是否存在 `{视频名}_bilingual.json`
2. 如果存在，弹出对话框询问是否使用现有字幕
3. 选择"是"：直接加载现有字幕，无需重新翻译
4. 选择"否"：重新进行语音识别和翻译

**优势**:
- 节省时间：无需重复翻译
- 节省资源：不消耗网络和计算资源
- 用户可选：可以随时选择重新生成

## 使用流程

### 首次使用
1. 打开视频文件
2. 系统自动进行语音识别和翻译
3. 处理完成后，在视频同目录自动生成：
   - `视频名_bilingual.json` - 用于本应用
   - `视频名_bilingual.srt` - 用于其他播放器

### 再次使用同一视频
1. 打开视频文件
2. 系统检测到已有字幕文件
3. 选择"是"使用现有字幕，瞬间加载完成
4. 或选择"否"重新生成字幕

## 文件说明

### 生成的字幕文件位置
```
视频所在目录/
├── 视频文件.mp4
├── 视频文件_bilingual.json  # 本应用使用的字幕文件
└── 视频文件_bilingual.srt   # 通用字幕文件
```

### 缓存文件位置
```
项目目录/cache/
├── audio/          # 提取的音频文件缓存
└── subtitles/      # 字幕文件缓存
```

## 技术细节

### PyQt6视频播放
- QMediaPlayer需要同时设置VideoOutput和AudioOutput
- 设置顺序：先创建widget，再设置输出

### 字幕格式
- **JSON格式**: 包含完整的结构化数据，支持时间戳、双语文本
- **SRT格式**: 标准字幕格式，兼容性好

### 检测机制
- 基于文件名匹配：`{视频名}_bilingual.json`
- 使用pathlib进行跨平台路径处理
- 异常处理：加载失败时自动回退到重新生成

## 兼容性

- ✅ Windows
- ✅ macOS
- ✅ Linux

## 下次使用建议

1. 不要删除生成的 `*_bilingual.json` 文件
2. SRT文件可以在其他播放器（如VLC、PotPlayer）中使用
3. 如果需要修改字幕，可以直接编辑JSON文件
